"use strict";function site(){function t(t,n){n.on({mouseover:o,mouseout:e})}function o(t){var o=t.target;for(var e in p)for(var n in p[e].options.town)if(o.feature.properties.TOWNNAME===p[e].options.town[n]){var r=p[e];r.setOpacity(1);for(var i in r.options.town)for(var a in s._layers)s._layers[a].feature.properties.TOWNNAME===r.options.town[i]&&s._layers[a].setStyle({weight:2,color:"#758de5",fillColor:"#758de5",fillOpacity:.7})}o.setStyle({weight:2,color:"#666",fillOpacity:.7}),L.Browser.ie||L.Browser.opera||L.Browser.edge||o.bringToFront(),l.update(o.feature.properties)}function e(t){s.resetStyle(t.target);for(var o in s._layers)s.resetStyle(s._layers[o]);for(var e in p)p[e].setOpacity(.5)}function n(){c=new L.Map("siteMap",{center:new L.LatLng(23.13,120.3),zoom:10.2}),c.touchZoom.disable(),c.doubleClickZoom.disable(),c.scrollWheelZoom.disable(),c.boxZoom.disable(),c.keyboard.disable();new L.TileLayer("https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicmFwaXJlbnQiLCJhIjoiY2oybXBsc2ZvMDE2YjMycGg4NzNkYXI0OSJ9.xC8TBirQ2os2eQ65hwTCMA",{minZoom:1,maxZoom:20,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(c),l.addTo(c),d.addTo(c),u.addTo(c),$.ajax({type:"GET",url:"./src/data/淨水廠.csv",dataType:"text",success:function(t){var o=$.csv.toObjects(t);for(var e in o){var n=L.ExtraMarkers.icon({icon:"fa-tint",iconColor:"white",markerColor:r(o[e]),shape:"circle",prefix:"fa"}),i=L.marker(L.latLng(o[e].lat,o[e].lng),{icon:n,town:o[e]["轄區"].split("、"),name:o[e]["淨水場名稱"],opacity:.5}).addTo(c);i.bindPopup("<strong>"+o[e]["淨水場名稱"]+"</strong><br>主要供水轄區:<strong>"+o[e][" 主要供水轄區"]+"</strong><br>總溶解固體量(Total Dissolved Solids):<strong>"+o[e]["總溶解固體量(Total Dissolved Solids)"]+"</strong><br>pH值(pH ):<strong>"+o[e]["pH值(pH )"]+"</strong><br>總硬度(Total Hardness):<strong>"+o[e]["總硬度(Total Hardness)"]+"</strong><br>鐵(Iron):<strong>"+o[e]["鐵(Iron)"]+"</strong><br>水質合格否(Y/N):<strong>"+o[e]["水質合格否(Y/N)"]+"</strong>"),i.on("popupopen",function(){this.setOpacity(1)}),i.on("popupclose",function(){c.setView(new L.LatLng(23.13,120.3),10.2)}),i.on("mouseover",function(){this.setOpacity(1);var t=this.options.town;for(var o in t)for(var e in s._layers)if(s._layers[e].feature.properties.TOWNNAME===t[o]){var n=s._layers[e];n.setStyle({weight:2,color:"#758de5",fillColor:"#758de5",fillOpacity:.7})}}),i.on("mouseout",function(){this.setOpacity(.5);var t=this.options.town;for(var o in t)for(var e in s._layers)s._layers[e].feature.properties.TOWNNAME===t[o]&&s.resetStyle(s._layers[e])}),p.push(i)}}})}function r(t){return"Y"===t["水質合格否(Y/N)"].toString()?"blue":"N"===t["水質合格否(Y/N)"].toString()?"red":"black"}function i(t){return{fillColor:"#333",weight:2,opacity:1,color:"#eee",dashArray:"3",fillOpacity:.4}}var a=void 0,s=void 0,c=void 0,l=L.control(),d=L.control().setPosition("topleft"),u=L.control().setPosition("topleft"),p=[];$.getJSON("./src/data/tainan-town.geojson",function(o){a=o,s=L.geoJson(a,{style:i,onEachFeature:t}),s.addTo(c),l.update()}),$(document).ready(function(){n()}),l.onAdd=function(t){return this._div=L.DomUtil.create("div","siteInfo"),this._div.innerHTML="<h4>圖層載入中</h4>",this._div},l.update=function(t){if(t)for(var o in p)for(var e in p[o].options.town)p[o].options.town[e]===t.TOWNNAME&&(this._div.innerHTML="<h4><strong>"+t.TOWNNAME+"</strong></h4><h4>所屬淨水廠名稱:</h4>"+p[o].options.name);else this._div.innerHTML="<h4>請點選畫面區塊</h4>"},d.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","map outline icon",t);return $(o).on("click",function(){c.setView([23.13,120.3],10.2)}),$(o).attr("title","回到台南"),t},u.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","compass icon",t);return $(o).on("click",function(){if(navigator.geolocation)return navigator.geolocation.getCurrentPosition(function(t){c.setView(new L.LatLng(t.coords.latitude,t.coords.longitude),12)})}),$(o).attr("title","取得您的位置"),t}}function river(){function t(){$.getJSON("./src/data/siteInfo.json",function(t){d=t;for(var e in d)if(d[e].SiteName in u){if(u[d[e].SiteName].RPI=parseFloat(u[d[e].SiteName].RPI),isNaN(u[d[e].SiteName].RPI))continue;var r=o(u[d[e].SiteName].RPI),i=L.ExtraMarkers.icon({prefix:"fa",icon:"fa-map-marker",iconColor:"white",markerColor:r.color,shipe:"circle"}),a=L.marker([d[e].TWD97Lat,d[e].TWD97Lon],{icon:i,opacity:.9}).addTo(l);a.bindPopup("<strong>測站名稱："+d[e].SiteName+'</strong><br/><span class="red">污染程度：'+r.disc+"</span><br/>所屬流域："+d[e].Basin+"<br/>RPI指標："+u[d[e].SiteName].RPI+"<br/>酸鹼值："+u[d[e].SiteName].PH+"<br/>懸浮固體："+u[d[e].SiteName].SS+"（mg/L）<br/>溶氧量："+u[d[e].SiteName].DO+"（mg/L）<br/>生化需氧量："+u[d[e].SiteName].COD+"（mg/L）<br/>氨氮："+u[d[e].SiteName].NH3N+"（mg/L）<br/>地址："+d[e].SiteAddress),d[e].Basin in f?(f[d[e].Basin].RPI+=u[d[e].SiteName].RPI,f[d[e].Basin].siteNumber+=1):(f[d[e].Basin]={},f[d[e].Basin].RPI=u[d[e].SiteName].RPI,f[d[e].Basin].siteNumber=1)}for(var e in f)f[e].RPI=parseFloat(f[e].RPI)/f[e].siteNumber;p=L.geoJson(m,{style:n,onEachFeature:c}),p.addTo(l)})}function o(t){return t<=2?{disc:"未(稍)受污染",color:"blue"}:t<=3?{disc:"輕度污染",color:"orange"}:t<=6?{disc:"中度污染",color:"red"}:{disc:"嚴重污染",color:"darkpurple"}}function e(){l=new L.Map("RiverMap",{center:new L.LatLng(23.13,120.3),zoom:10.2}),l.doubleClickZoom.disable(),l.scrollWheelZoom.disable();new L.TileLayer("https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicmFwaXJlbnQiLCJhIjoiY2oybXBsc2ZvMDE2YjMycGg4NzNkYXI0OSJ9.xC8TBirQ2os2eQ65hwTCMA",{minZoom:1,maxZoom:16,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(l),g.addTo(l),y.addTo(l),v.addTo(l),h.addTo(l)}function n(t){return{fillColor:r(t.properties.name),weight:2,opacity:1,color:"#eee",dashArray:"3",fillOpacity:.4}}function r(t){var o=0;return t+"流域"in f?(o=f[t+"流域"].RPI,o<=2?"#39AADD":o<=3?"#E39941":o<=6?"#D24C39":"#684064"):"transparent"}function i(t){var o=t.target;o.setStyle({weight:5,color:"#666",dashArray:"",fillOpacity:.5}),L.Browser.ie||L.Browser.opera||o.bringToFront(),g.update(o.feature.properties)}function a(t){p.resetStyle(t.target)}function s(t){l.fitBounds(t.target.getBounds()),g.update(t.target.feature.properties)}function c(t,o){o.on({mouseover:i,mouseout:a,click:s})}var l=void 0,d=void 0,u=void 0,p=void 0,f={},m=null,g=L.control(),v=L.control().setPosition("topleft"),h=L.control().setPosition("topleft"),y=L.control({position:"bottomleft"});$.getJSON("./src/data/tainanCounty2010merge.json",function(t){t=L.geoJson(t,{style:{fillColor:"#333",weight:2,opacity:1,color:"#eee",dashArray:"3",fillOpacity:.4}}),t.addTo(l)}),$.getJSON("./src/data/river.geojson",function(t){m=t,p=L.geoJson(m,{style:n,onEachFeature:c}),p.addTo(l),g.update()}),$(document).ready(function(){e(),$.getJSON("./src/data/river.json",function(o){u=o,t()})}),g.onAdd=function(t){return this._div=L.DomUtil.create("div","riverInfo"),this._div.innerHTML="<h4>流域圖層載入中 </h4>",this._div},g.update=function(t){t&&t.name+"流域"in f?this._div.innerHTML="<h4>河川流域名稱："+(t?t.name+"</h4>平均污染指數RPI："+f[t.name+"流域"].RPI.toFixed(1):"</h4>請點選畫面區塊"):this._div.innerHTML="<h4>河川流域名稱："+(t?t.name+"</h4>流域內無測站資料":"</h4>請點選畫面區塊")},y.onAdd=function(t){for(var o=L.DomUtil.create("div","riverInfo legend"),e=["#684064","#D24C39","#E39941","#39AADD"],n=["嚴重污染（6+）","中度污染（3-6）","輕度污染（2-3）","未（稍）受污染（0-2）"],r=0;r<n.length;r++)o.innerHTML+='<i style="background:'+e[r]+'"></i>'+n[r]+"<br/>";return o},v.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","map outline icon",t);return $(o).on("click",function(){l.setView([23.13,120.3],10.2)}),$(o).attr("title","縮放至整個台南市"),t},h.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","compass icon",t);return $(o).on("click",function(){if(navigator.geolocation)return navigator.geolocation.getCurrentPosition(function(t){l.setView(new L.LatLng(t.coords.latitude,t.coords.longitude),12)})}),$(o).attr("title","取得您的位置"),t}}function rain(){function t(){d3.csv("./src/data/酸雨監測值.csv",function(t,s){t&&console.log(t);var c=function(t){var o=[];for(var e in t)o.push(t[e]["監測日期"]);return o}(s),l=d3.max(s,function(t){return parseFloat(t["酸雨pH值"])}),d=d3.min(s,function(t){return parseFloat(t["酸雨pH值"])}),u=d3.scale.linear().domain([0,s.length]).range([n+r,a-i-o.left-o.right-n]),p=d3.scale.linear().domain([d,l]).range([e-o.top-o.bottom-n,n]),f=d3.select(".initChart"),m=d3.svg.axis().scale(u).tickFormat(function(t,o){return c[o]}).tickSize(1).ticks(s.length).orient("bottom"),g=d3.svg.axis().scale(p).tickSize(1).orient("left");f.append("g").attr({class:"yAxis",transform:"translate("+r+",0)"}).call(g).append("text").attr({"text-anchor":"start"}),f.append("g").attr({class:"xAxis",transform:"translate(0,"+(e-o.top-o.bottom)+")"}).call(m).selectAll("text").style("text-anchor","start").attr({transform:"rotate(45)"}),f.append("text").attr({class:"yLabel","text-anchor":"end",x:r,y:e-o.top-o.bottom-n,dy:"2em",opacity:.5}).text("(pH值)");var v=d3.svg.line().x(1).y(1).interpolate("linear"),h=d3.svg.line().x(function(t,o){return u(o)}).y(function(t){return p(t["酸雨pH值"])}).interpolate("linear");f.append("path").attr({id:"line",d:v(s),y:0,stroke:"#666","stroke-width":"0.5px",fill:"none"}).transition().duration(1e3).attr("d",h(s));var L=d3.select("body").append("div").attr("class","info").style("opacity",0),y=void 0;f.selectAll(".point").data(s).enter().append("circle").attr({cx:function(t,o){return u(o)},cy:function(t){return p(t["酸雨pH值"])},r:function(t){var o=Math.sqrt(10*t["雨量累計 (mm)"]);return o<9?9:o},fill:function(t){return t["酸雨pH值"]>=5.6?"#758de5":t["酸雨pH值"]>=5?"#ff7800":"#ea5a5a"},opacity:.5,id:function(t){return t["序號"]},date:function(t){return t["監測日期"]},elect:function(t){return t["雨水導電度 (μS/cm)"]},total:function(t){return t["雨量累計 (mm)"]},site:function(t){return t["測站"]}}).on("mouseover",function(){d3.select(this).attr({opacity:.9,stroke:"rgba(0, 0, 0, 0.12)","stroke-width":2,cursor:"pointer"})}).on("mouseout",function(){d3.select(this).attr({opacity:.5,stroke:"rgba(0, 0, 0, 0.12)","stroke-width":0})}).on("click",function(){d3.select(this).attr("id")!==y?(L.html('<div id="info"> 監測日期: <strong>'+d3.select(this).attr("date")+"</strong><br>雨水導電度 (μS/cm): <strong>"+d3.select(this).attr("elect")+"</strong><br>雨量累計 (mm): <strong>"+d3.select(this).attr("total")+"</strong><br>測站: <strong>"+d3.select(this).attr("site")+"</div>").style({left:d3.event.pageX+"px",top:d3.event.pageY+"px",opacity:1,"z-index":999}),y=d3.select(this).attr("id")):(y=0,L.style({opacity:0,"z-index":-1}))})})}var o={top:10,right:0,bottom:140,left:0},e=450,n=30,r=80,i=120,a=800+r+i;$(document).ready(function(){d3.select("#column").append("initChart").append("svg").attr("width",a).attr("height",e).attr("class","initChart"),t()})}function groundwater(){function t(t){var e={},n=!1;for(var r in o)t[r]>o[r]&&(n=!0,e[r+"  :"]=t[r]);return!0===n?{disc:e,color:"red"}:{disc:e,color:"blue"}}var o={"砷 Arsenic (mg/L)":.25,"鎘 Cadmium (mg/L)":.025,"鉻 Chromium (mg/L)":.25,"銅 Copper (mg/L)":.25,"鉛 Lead (mg/L)":.05,"汞 Mercury (mg/L)":.01,"鋅 Zinc (mg/L)":25,"鐵 Iron (mg/L)":1.5,"錳 Manganese (mg/L)":.25,"總硬度 Total Hardness (mg/L as CaCO3)":750,"總溶解固體物 Total Dissolved Solid (mg/L)":1250,"氯鹽 Chloride (mg/L)":625,"氨氮 NH3-N (mg/L)":.25,"硝酸鹽氮 Nitrate-Nitrogen (mg/L)":50,"硫酸鹽 Sulfate (mg/L)":625,"總有機碳 Total Organic Carbon (mg/L)":10},e=L.control().setPosition("topleft"),n=L.control().setPosition("topleft"),r=void 0,i=void 0,a=null;$(document).ready(function(){$.getJSON("./src/data/tainanCounty2010merge.json",function(t){a=t,i=L.geoJson(a,{style:{fillColor:"#333",weight:2,opacity:1,color:"#eee",dashArray:"3",fillOpacity:.2}}),i.addTo(r),e.addTo(r),n.addTo(r)})}),function(){r=new L.Map("groundWater",{center:new L.LatLng(23.13,120.3),zoom:10.2}),r.doubleClickZoom.disable(),r.scrollWheelZoom.disable(),new L.TileLayer("https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicmFwaXJlbnQiLCJhIjoiY2oybXBsc2ZvMDE2YjMycGg4NzNkYXI0OSJ9.xC8TBirQ2os2eQ65hwTCMA",{minZoom:1,maxZoom:16,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(r),d3.csv("./src/data/地下水水質監測與指標資料.csv",function(o,e){o&&console.log(o);for(var n in e){var i=t(e[n]),a=L.ExtraMarkers.icon({icon:"fa-tint",iconColor:"white",markerColor:i.color,shape:"circle",prefix:"fa"}),s=L.marker(L.latLng(e[n].TWD97Lat,e[n].TWD97Lon),{icon:a,opacity:.7}).addTo(r),c="";for(var l in i.disc)c+="</span><br>"+l+'<span class="red">',c+=i.disc[l];s.bindPopup("測站:<strong>"+e[n]["測站"]+"</strong><br>地址:<strong>"+e[n].SiteAddress+"</strong><br>最後採樣日期:<strong>"+e[n]["採樣日期"]+"</strong><hr>超標項目"+(""===c?"":"<span>")+c)}})}(),e.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","map outline icon",t);return $(o).on("click",function(){r.setView([23.13,120.3],10.2)}),$(o).attr("title","回到台南"),t},n.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","compass icon",t);return $(o).on("click",function(){if(navigator.geolocation)return navigator.geolocation.getCurrentPosition(function(t){r.setView(new L.LatLng(t.coords.latitude,t.coords.longitude),12)})}),$(o).attr("title","取得您的位置"),t}}$(window).ready(function(){site(),river(),rain(),groundwater()});
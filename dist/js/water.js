"use strict";function site(){function t(t,i){!0===trigger?i.on("click",o):i.on({mouseover:o,click:e})}function o(t){var o=t.target;u.update(o.feature.properties);for(var i in f)for(var r in f[i].options.town)if(o.feature.properties.TOWNNAME===f[i].options.town[r]){var n=f[i];if(n.setOpacity(1),!0===trigger&&s===i&&!0===a)return a=!1,e(t);s=i,a=!0;for(var c in n.options.town)for(var d in l._layers)l._layers[d].feature.properties.TOWNNAME===n.options.town[c]&&l._layers[d].setStyle({weight:2,color:"#758de5",fillColor:"#758de5",fillOpacity:.7});return o.setStyle({weight:2,color:"#666",fillOpacity:.7}),L.Browser.ie||L.Browser.opera||L.Browser.edge||o.bringToFront(),null}}function e(t){l.resetStyle(t.target);for(var o in l._layers)l.resetStyle(l._layers[o]);for(var e in f)f[e].setOpacity(.5)}function i(){d=new L.Map("siteMap",{center:new L.LatLng(23.13,120.3),zoom:10.2}),d.touchZoom.disable(),d.doubleClickZoom.disable(),d.scrollWheelZoom.disable(),d.boxZoom.disable(),d.keyboard.disable();new L.TileLayer("https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicmFwaXJlbnQiLCJhIjoiY2oybXBsc2ZvMDE2YjMycGg4NzNkYXI0OSJ9.xC8TBirQ2os2eQ65hwTCMA",{minZoom:1,maxZoom:20,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(d),u.addTo(d),p.addTo(d),g.addTo(d),$.ajax({type:"GET",url:"./src/data/淨水廠.csv",dataType:"text",success:function(t){var o=$.csv.toObjects(t);for(var e in o){var i=L.ExtraMarkers.icon({icon:"fa-tint",iconColor:"white",markerColor:r(o[e]),shape:"circle",prefix:"fa"}),n=L.marker(L.latLng(o[e].lat,o[e].lng),{icon:i,town:o[e]["轄區"].split("、"),name:o[e]["淨水場名稱"],opacity:.5}).addTo(d);n.bindPopup("<strong>"+o[e]["淨水場名稱"]+"</strong><br>主要供水轄區:<strong>"+o[e][" 主要供水轄區"]+"</strong><br>總溶解固體量(Total Dissolved Solids):<strong>"+o[e]["總溶解固體量(Total Dissolved Solids)"]+"</strong><br>pH值(pH ):<strong>"+o[e]["pH值(pH )"]+"</strong><br>總硬度(Total Hardness):<strong>"+o[e]["總硬度(Total Hardness)"]+"</strong><br>鐵(Iron):<strong>"+o[e]["鐵(Iron)"]+"</strong><br>水質合格否(Y/N):<strong>"+o[e]["水質合格否(Y/N)"]+"</strong>"),n.on("popupopen",function(){if(this.setOpacity(1),!0===trigger){var t=this.options.town;for(var o in t)for(var e in l._layers)if(l._layers[e].feature.properties.TOWNNAME===t[o]){var i=l._layers[e];i.setStyle({weight:2,color:"#758de5",fillColor:"#758de5",fillOpacity:.7})}}}),n.on("popupclose",function(){if(d.setView(new L.LatLng(23.13,120.3),10.2),this.setOpacity(.5),!0===trigger){var t=this.options.town;for(var o in t)for(var e in l._layers)l._layers[e].feature.properties.TOWNNAME===t[o]&&l.resetStyle(l._layers[e])}}),!0!==trigger&&(n.on("mouseover",function(){this.setOpacity(1);var t=this.options.town;for(var o in t)for(var e in l._layers)if(l._layers[e].feature.properties.TOWNNAME===t[o]){var i=l._layers[e];i.setStyle({weight:2,color:"#758de5",fillColor:"#758de5",fillOpacity:.7})}}),n.on("mouseout",function(){this.setOpacity(.5);var t=this.options.town;for(var o in t)for(var e in l._layers)l._layers[e].feature.properties.TOWNNAME===t[o]&&l.resetStyle(l._layers[e])})),f.push(n)}}})}function r(t){return"Y"===t["水質合格否(Y/N)"].toString()?"blue":"N"===t["水質合格否(Y/N)"].toString()?"red":"black"}function n(t){return{fillColor:"#333",weight:2,opacity:1,color:"#eee",dashArray:"3",fillOpacity:.4}}var a=!1,s=null,c=void 0,l=void 0,d=void 0,u=L.control().setPosition("bottomleft"),p=L.control(),g=L.control(),f=[];$.getJSON("./src/data/tainan-town.geojson",function(o){c=o,l=L.geoJson(c,{style:n,onEachFeature:t}),l.addTo(d),u.update()}),$(document).ready(function(){i()}),u.onAdd=function(t){return this._div=L.DomUtil.create("div","siteInfo"),this._div.innerHTML="<h4>圖層載入中</h4>",this._div},u.update=function(t){if(t)for(var o in f)for(var e in f[o].options.town)f[o].options.town[e]===t.TOWNNAME&&(this._div.innerHTML="<h4><strong>"+t.TOWNNAME+"</strong></h4><h4>所屬淨水廠名稱:</h4>"+f[o].options.name);else this._div.innerHTML="<h4>請點選畫面區塊</h4>"},p.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","map outline icon",t);return $(o).on("click",function(){d.setView([23.13,120.3],10.2)}),$(o).attr("title","回到台南"),t},g.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","compass icon",t);return $(o).on("click",function(){if(navigator.geolocation)return navigator.geolocation.getCurrentPosition(function(t){d.setView(new L.LatLng(t.coords.latitude,t.coords.longitude),12)})}),$(o).attr("title","取得您的位置"),t}}function river(){function t(){$.getJSON("./src/data/siteInfo.json",function(t){d=t;for(var e in d)if(d[e].SiteName in u){if(u[d[e].SiteName].RPI=parseFloat(u[d[e].SiteName].RPI),isNaN(u[d[e].SiteName].RPI))continue;var r=o(u[d[e].SiteName].RPI),n=L.ExtraMarkers.icon({prefix:"fa",icon:"fa-map-marker",iconColor:"white",markerColor:r.color,shipe:"circle"}),a=L.marker([d[e].TWD97Lat,d[e].TWD97Lon],{icon:n,opacity:.9}).addTo(l);a.bindPopup("<strong>測站名稱："+d[e].SiteName+'</strong><br/><span class="red">污染程度：'+r.disc+"</span><br/>所屬流域："+d[e].Basin+"<br/>RPI指標："+u[d[e].SiteName].RPI+"<br/>酸鹼值："+u[d[e].SiteName].PH+"<br/>懸浮固體："+u[d[e].SiteName].SS+"（mg/L）<br/>溶氧量："+u[d[e].SiteName].DO+"（mg/L）<br/>生化需氧量："+u[d[e].SiteName].COD+"（mg/L）<br/>氨氮："+u[d[e].SiteName].NH3N+"（mg/L）<br/>地址："+d[e].SiteAddress),d[e].Basin in g?(g[d[e].Basin].RPI+=u[d[e].SiteName].RPI,g[d[e].Basin].siteNumber+=1):(g[d[e].Basin]={},g[d[e].Basin].RPI=u[d[e].SiteName].RPI,g[d[e].Basin].siteNumber=1)}for(var e in g)g[e].RPI=parseFloat(g[e].RPI)/g[e].siteNumber;p=L.geoJson(f,{style:i,onEachFeature:c}),p.addTo(l)})}function o(t){return t<=2?{disc:"未(稍)受污染",color:"blue"}:t<=3?{disc:"輕度污染",color:"orange"}:t<=6?{disc:"中度污染",color:"red"}:{disc:"嚴重污染",color:"darkpurple"}}function e(){l=new L.Map("RiverMap",{center:new L.LatLng(23.13,120.3),zoom:10.2}),l.doubleClickZoom.disable(),l.scrollWheelZoom.disable();new L.TileLayer("https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicmFwaXJlbnQiLCJhIjoiY2oybXBsc2ZvMDE2YjMycGg4NzNkYXI0OSJ9.xC8TBirQ2os2eQ65hwTCMA",{minZoom:1,maxZoom:16,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(l),m.addTo(l),y.addTo(l),h.addTo(l),v.addTo(l)}function i(t){return{fillColor:r(t.properties.name),weight:2,opacity:1,color:"#eee",dashArray:"3",fillOpacity:.4}}function r(t){var o=0;return t+"流域"in g?(o=g[t+"流域"].RPI,o<=2?"#39AADD":o<=3?"#E39941":o<=6?"#D24C39":"#684064"):"transparent"}function n(t){var o=t.target;o.setStyle({weight:5,color:"#666",dashArray:"",fillOpacity:.5}),L.Browser.ie||L.Browser.opera||o.bringToFront(),m.update(o.feature.properties)}function a(t){p.resetStyle(t.target)}function s(t){l.fitBounds(t.target.getBounds()),m.update(t.target.feature.properties)}function c(t,o){o.on({mouseover:n,mouseout:a,click:s})}var l=void 0,d=void 0,u=void 0,p=void 0,g={},f=null,m=L.control(),h=L.control().setPosition("topleft"),v=L.control().setPosition("topleft"),y=L.control({position:"bottomleft"});$.getJSON("./src/data/tainanCounty2010merge.json",function(t){t=L.geoJson(t,{style:{fillColor:"#333",weight:2,opacity:1,color:"#eee",dashArray:"3",fillOpacity:.4}}),t.addTo(l)}),$.getJSON("./src/data/river.geojson",function(t){f=t,p=L.geoJson(f,{style:i,onEachFeature:c}),p.addTo(l),m.update()}),$(document).ready(function(){e(),$.getJSON("./src/data/river.json",function(o){u=o,t()})}),m.onAdd=function(t){return this._div=L.DomUtil.create("div","riverInfo"),this._div.innerHTML="<h4>流域圖層載入中 </h4>",this._div},m.update=function(t){t&&t.name+"流域"in g?this._div.innerHTML="<h4>河川流域名稱："+(t?t.name+"</h4>平均污染指數RPI："+g[t.name+"流域"].RPI.toFixed(1):"</h4>請點選畫面區塊"):this._div.innerHTML="<h4>河川流域名稱："+(t?t.name+"</h4>流域內無測站資料":"</h4>請點選畫面區塊")},y.onAdd=function(t){for(var o=L.DomUtil.create("div","riverInfo legend"),e=["#684064","#D24C39","#E39941","#39AADD"],i=["嚴重污染（6+）","中度污染（3-6）","輕度污染（2-3）","未（稍）受污染（0-2）"],r=0;r<i.length;r++)o.innerHTML+='<i style="background:'+e[r]+'"></i>'+i[r]+"<br/>";return o},h.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","map outline icon",t);return $(o).on("click",function(){l.setView([23.13,120.3],10.2)}),$(o).attr("title","縮放至整個台南市"),t},v.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","compass icon",t);return $(o).on("click",function(){if(navigator.geolocation)return navigator.geolocation.getCurrentPosition(function(t){l.setView(new L.LatLng(t.coords.latitude,t.coords.longitude),12)})}),$(o).attr("title","取得您的位置"),t}}function rain(){function t(){d3.csv("./src/data/酸雨監測值.csv",function(t,o){t&&console.log(t);var e=function(t){var o=[];for(var e in t)o.push(t[e]["監測日期"]);return o}(o),i=d3.max(o,function(t){return parseFloat(t["酸雨pH值"])}),r=d3.min(o,function(t){return parseFloat(t["酸雨pH值"])}),n=d3.scale.linear().domain([0,o.length]).range([padding+axisPadding,width-margin.left-margin.right-padding]),a=d3.scale.linear().domain([r,i]).range([height-margin.top-margin.bottom-padding,padding]),s=d3.select(".initChart"),c=void 0,l=d3.svg.axis().scale(a).tickSize(1).orient("left");$(window).width()<786?(c=d3.svg.axis().scale(n).tickFormat("").tickSize(0).orient("bottom"),$(".rainInfo").css("display","block")):($(".rainInfo").css("display","none"),c=d3.svg.axis().scale(n).tickFormat(function(t,o){return e[o]}).tickSize(1).ticks(o.length).orient("bottom"),s.append("text").attr({class:"yLabel","text-anchor":"end",x:axisPadding,y:height-margin.top-margin.bottom-padding,dy:"2em",opacity:.5}).text("(pH值)")),s.append("g").attr({class:"yAxis",transform:"translate("+axisPadding+",0)"}).call(l).append("text").attr({"text-anchor":"start"}),s.append("g").attr({class:"xAxis",transform:"translate(0,"+(height-margin.top-margin.bottom)+")"}).call(c).selectAll("text").style("text-anchor","start").attr({transform:"rotate(45)"});var d=d3.svg.line().x(function(){return n(1)}).y(function(){return a(r)}).interpolate("linear"),u=d3.svg.line().x(function(t,o){return n(o)}).y(function(t){return a(t["酸雨pH值"])}).interpolate("linear");s.append("path").attr({id:"line",d:d(o),y:0,stroke:"#666","stroke-width":"0.5px",fill:"none"}).transition().duration(1500).attr("d",u(o));var p=d3.select("body").append("div").attr("class","info").style("opacity",0),g=0,f=s.selectAll(".point").data(o).enter().append("circle").attr({cx:function(){return n(1)},cy:function(t){return a(r)},r:function(t){if(!0===trigger)return 9;var o=Math.sqrt(10*t["雨量累計 (mm)"]);return o<9?9:o},fill:function(t){return t["酸雨pH值"]>=5.6?"#758de5":t["酸雨pH值"]>=5?"#ff7800":"#ea5a5a"},opacity:.5,class:"rainPoint",id:function(t){return t["序號"]},date:function(t){return t["監測日期"]},elect:function(t){return t["雨水導電度 (μS/cm)"]},total:function(t){return t["雨量累計 (mm)"]},site:function(t){return t["測站"]}});f.transition().duration(1500).attr({cx:function(t,o){return n(o)},cy:function(t){return a(t["酸雨pH值"])}}),$(window).width()>=786?f.on("mouseover",function(){d3.select(this).attr({opacity:.9,stroke:"rgba(0, 0, 0, 0.12)","stroke-width":2,cursor:"pointer"})}).on("mouseout",function(){d3.select(this).attr({opacity:.5,stroke:"rgba(0, 0, 0, 0.12)","stroke-width":0})}).on("click",function(){d3.select(this).attr("id")!==g?(p.html('<div id="info"> 監測日期: <strong>'+d3.select(this).attr("date")+"</strong><br>雨水導電度 (μS/cm): <strong>"+d3.select(this).attr("elect")+"</strong><br>雨量累計 (mm): <strong>"+d3.select(this).attr("total")+"</strong><br>測站: <strong>"+d3.select(this).attr("site")+"</div>").style({left:d3.event.pageX+"px",top:d3.event.pageY+"px",opacity:1,"z-index":999}),g=d3.select(this).attr("id")):(g=0,p.style({opacity:0,"z-index":-1}))}):f.on("click",function(){$(".rainInfo").css("display","block"),d3.select(this).attr("id")!==g?(g=d3.select(this).attr("id"),$(".rainInfo").empty().html('<div id="info"> 監測日期: <strong>'+d3.select(this).attr("date")+"</strong><br>雨水導電度 (μS/cm): <strong>"+d3.select(this).attr("elect")+"</strong><br>雨量累計 (mm): <strong>"+d3.select(this).attr("total")+"</strong><br>測站: <strong>"+d3.select(this).attr("site")+"</div>"),d3.selectAll(".rainPoint").style({opacity:.5,stroke:"rgba(0, 0, 0, 0.12)","stroke-width":0}),d3.select(this).style({opacity:.9,stroke:"rgba(0, 0, 0, 0.12)","stroke-width":2,cursor:"pointer"})):(g=0,d3.select(this).style({opacity:.5,stroke:"rgba(0, 0, 0, 0.12)","stroke-width":0}),$(".rainInfo").css("display","none"))})})}$(document).ready(function(){d3.selectAll("initChart").remove(),d3.select("#column").append("initChart").append("svg").attr("width",width).attr("height",height).attr("class","initChart"),t()})}function groundwater(){function t(t){var e={},i=!1;for(var r in o)t[r]>o[r]&&(i=!0,e[r+"  :"]=t[r]);return!0===i?{disc:e,color:"red"}:{disc:e,color:"blue"}}var o={"砷 Arsenic (mg/L)":.25,"鎘 Cadmium (mg/L)":.025,"鉻 Chromium (mg/L)":.25,"銅 Copper (mg/L)":.25,"鉛 Lead (mg/L)":.05,"汞 Mercury (mg/L)":.01,"鋅 Zinc (mg/L)":25,"鐵 Iron (mg/L)":1.5,"錳 Manganese (mg/L)":.25,"總硬度 Total Hardness (mg/L as CaCO3)":750,"總溶解固體物 Total Dissolved Solid (mg/L)":1250,"氯鹽 Chloride (mg/L)":625,"氨氮 NH3-N (mg/L)":.25,"硝酸鹽氮 Nitrate-Nitrogen (mg/L)":50,"硫酸鹽 Sulfate (mg/L)":625,"總有機碳 Total Organic Carbon (mg/L)":10},e=L.control().setPosition("topleft"),i=L.control().setPosition("topleft"),r=void 0,n=void 0,a=null;$(document).ready(function(){$.getJSON("./src/data/tainan-town.geojson",function(t){a=t,n=L.geoJson(a,{style:{fillColor:"#333",weight:2,opacity:1,color:"#eee",dashArray:"3",fillOpacity:.2}}),n.addTo(r),e.addTo(r),i.addTo(r)})}),function(){r=new L.Map("groundWater",{center:new L.LatLng(23.13,120.3),zoom:10.2}),r.doubleClickZoom.disable(),r.scrollWheelZoom.disable(),new L.TileLayer("https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicmFwaXJlbnQiLCJhIjoiY2oybXBsc2ZvMDE2YjMycGg4NzNkYXI0OSJ9.xC8TBirQ2os2eQ65hwTCMA",{minZoom:1,maxZoom:16,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(r),d3.csv("./src/data/地下水水質監測與指標資料.csv",function(o,e){o&&console.log(o);for(var i in e){var n=t(e[i]),a=L.ExtraMarkers.icon({icon:"fa-tint",iconColor:"white",markerColor:n.color,shape:"circle",prefix:"fa"}),s=L.marker(L.latLng(e[i].TWD97Lat,e[i].TWD97Lon),{icon:a,opacity:.7}).addTo(r),c="";for(var l in n.disc)c+="</span><br>"+l+'<span class="red">',c+=n.disc[l];s.on("popupopen",function(){this.setOpacity(1)}),s.on("popupclose",function(){this.setOpacity(.7)}),s.bindPopup("測站:<strong>"+e[i]["測站"]+"</strong><br>地址:<strong>"+e[i].SiteAddress+"</strong><br>最後採樣日期:<strong>"+e[i]["採樣日期"]+"</strong>"+(""===c?"<hr>無超標項目":"<hr>超標項目<span>")+c)}})}(),e.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","map outline icon",t);return $(o).on("click",function(){r.setView([23.13,120.3],10.2)}),$(o).attr("title","回到台南"),t},i.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","compass icon",t);return $(o).on("click",function(){if(navigator.geolocation)return navigator.geolocation.getCurrentPosition(function(t){r.setView(new L.LatLng(t.coords.latitude,t.coords.longitude),12)})}),$(o).attr("title","取得您的位置"),t}}var margin={top:10,right:0,bottom:140,left:0},height=450,padding=30,barMargin=5,axisPadding=80,trigger=!1,width=800+axisPadding;$(window).ready(function(){site(),river(),rain(),groundwater(),$(window).width()<786&&(d3.selectAll("initChart").remove(),$("#siteMap, #groundWater").css({width:"100%",transform:"translateX(0)"}),axisPadding=40,width=$(window).width()-90+axisPadding,margin.bottom=20,trigger=!0,rain()),$(window).resize(function(){$(window).width()<786&&!1===trigger?(d3.selectAll("initChart").remove(),$("#siteMap, #groundWater").css({width:"100%",transform:"translateX(0)"}),axisPadding=40,width=$(window).width()-90+axisPadding,margin.bottom=20,trigger=!0,rain()):!0===trigger&&(d3.selectAll("initChart").remove(),$("#siteMap, #groundWater").css({width:"50%",transform:"translateX(50%)"}),trigger=!1,axisPadding=80,width=800+axisPadding,margin.bottom=140,rain())})});
"use strict";function reservoir(){function o(o){return o>50?"#2BF888":o>40?"#2BAD88":o!==o==!1?"#288":"#333"}function e(){function o(o){return{fillColor:t(o.properties.name),weight:1,opacity:1,color:"#333",dashArray:"3",fillOpacity:.7}}r=new L.Map("reservoirMap",{center:new L.LatLng(23.25,120.3),zoom:10.2,zoomControl:!1}),r.touchZoom.disable(),r.doubleClickZoom.disable(),r.scrollWheelZoom.disable(),r.boxZoom.disable(),r.keyboard.disable(),r.dragging.disable();new L.TileLayer("https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicmFwaXJlbnQiLCJhIjoiY2oybXBsc2ZvMDE2YjMycGg4NzNkYXI0OSJ9.xC8TBirQ2os2eQ65hwTCMA",{minZoom:1,maxZoom:20,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(r),$.getJSON("./src/data/jishuei.geojson",function(e){var t=L.geoJSON(e,{style:o,onEachFeature:function(o,e){e.on("mouseover",function(o){i(o)}),e.on("mouseout",function(o){t.resetStyle(o.target)}),e.on("click",function(o){n(o,s),s=!s})}}).addTo(r)})}function t(e){var t=0,n=0;for(var i in a)a[i].Site==e&&(t+=parseFloat(a[i].CTSI),n++);return o(t/n)}function n(o,e){o.target;if(!1===e){new Promise(function(){r.fitBounds(o.target.getBounds())})}else r.setView(new L.LatLng(23.25,120.3),10.2)}function i(o){var e=o.target;e.setStyle({fillColor:"#2B59FF",weight:2,color:"#000",fillOpacity:.7,zoom:20}),c.update(e.feature.properties)}var r,a=null,s=!1,c=L.control({position:"topleft"}),l=L.control({position:"bottomleft"});$.ajax({type:"GET",url:"./src/data/水庫水質.csv",dataType:"text",success:function(o){a=$.csv.toObjects(o)}}),$(document).ready(function(){e(),c.onAdd=function(o){return this._div=L.DomUtil.create("div","info"),this.update(),this._div},c.update=function(o){this._div.innerHTML="<h4>水庫名稱</h4>"+(o?"<b>\t"+o.name+"\t</b><br/>":"請選擇")},c.addTo(r),l.onAdd=function(e){for(var t=L.DomUtil.create("div","info legend"),n=[0,40,50],i=0;i<n.length;i++)t.innerHTML+='<i style="background:'+o(n[i]+1)+'"></i> '+n[i]+(n[i+1]?"&ndash;"+n[i+1]+"<br>":"");return t},l.addTo(r)})}function site(){function o(o,n){n.on({mouseover:e,mouseout:t})}function e(o){var e=o.target;e.setStyle({weight:5,color:"#666",fillOpacity:.7}),L.Browser.ie||L.Browser.opera||L.Browser.edge||e.bringToFront()}function t(o){s.resetStyle(o.target)}function n(){c=new L.Map("siteMap",{center:new L.LatLng(23.13,120.3),zoom:10.2,zoomControl:!1}),c.touchZoom.disable(),c.doubleClickZoom.disable(),c.scrollWheelZoom.disable(),c.boxZoom.disable(),c.keyboard.disable(),c.dragging.disable();new L.TileLayer("https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicmFwaXJlbnQiLCJhIjoiY2oybXBsc2ZvMDE2YjMycGg4NzNkYXI0OSJ9.xC8TBirQ2os2eQ65hwTCMA",{minZoom:1,maxZoom:20,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(c),$.ajax({type:"GET",url:"./src/data/淨水廠.csv",dataType:"text",success:function(o){var e=$.csv.toObjects(o);for(var t in e){var n=L.ExtraMarkers.icon({icon:"fa-tint",iconColor:"white",markerColor:i(e[t]),shape:"circle",prefix:"fa"}),r=L.marker(L.latLng(e[t].lat,e[t].lng),{icon:n,town:e[t]["轄區"].split("、")}).addTo(c);r.bindPopup("<strong>"+e[t]["淨水場名稱"]+"</strong><br>主要供水轄區:<strong>"+e[t][" 主要供水轄區"]+"</strong><br>總溶解固體量(Total Dissolved Solids):<strong>"+e[t]["總溶解固體量(Total Dissolved Solids)"]+"</strong><br>pH值(pH ):<strong>"+e[t]["pH值(pH )"]+"</strong><br>總硬度(Total Hardness):<strong>"+e[t]["總硬度(Total Hardness)"]+"</strong><br>鐵(Iron):<strong>"+e[t]["鐵(Iron)"]+"</strong><br>水質合格否(Y/N):<strong>"+e[t]["水質合格否(Y/N)"]+"</strong>"),r.on("popupclose",function(){c.setView(new L.LatLng(23.13,120.3),10.2)}),r.on("mouseover",function(){var o=this.options.town;for(var e in o)for(var t in s._layers)if(s._layers[t].feature.properties.TOWNNAME===o[e]){var n=s._layers[t];n.setStyle({weight:5,color:"blue",fillColor:"blue",fillOpacity:.7})}}),r.on("mouseout",function(){var o=this.options.town;for(var e in o)for(var t in s._layers)s._layers[t].feature.properties.TOWNNAME===o[e]&&s.resetStyle(s._layers[t])})}}})}function i(o){return console.log(o["水質合格否(Y/N)"]),"Y"===o["水質合格否(Y/N)"].toString()?"blue":"N"===o["水質合格否(Y/N)"].toString()?"red":"#666"}function r(o){return{fillColor:"#333",weight:2,opacity:1,color:"#eee",dashArray:"3",fillOpacity:.4}}var a,s,c;L.control();$.getJSON("./src/data/tainan-town.geojson",function(e){a=e,s=L.geoJson(a,{style:r,onEachFeature:o}),s.addTo(c),console.log(s)}),$(document).ready(function(){n()})}function river(){function o(){$.getJSON("./src/data/siteInfo.json",function(o){b=o;for(var t in b)if(b[t].SiteName in h){if(h[b[t].SiteName].RPI=parseFloat(h[b[t].SiteName].RPI),isNaN(h[b[t].SiteName].RPI))continue;var i=e(h[b[t].SiteName].RPI),r=L.ExtraMarkers.icon({prefix:"fa",icon:"map-marker",markerColor:i.color}),a=L.marker([b[t].TWD97Lat,b[t].TWD97Lon],{icon:r,opacity:.9}).addTo(m);a.bindPopup("<strong>測站名稱："+b[t].SiteName+'</strong><br/><span class="red">污染程度：'+i.disc+"</span><br/>所屬流域："+b[t].Basin+"<br/>RPI指標："+h[b[t].SiteName].RPI+"<br/>酸鹼值："+h[b[t].SiteName].PH+"<br/>懸浮固體："+h[b[t].SiteName].SS+"（mg/L）<br/>溶氧量："+h[b[t].SiteName].DO+"（mg/L）<br/>生化需氧量："+h[b[t].SiteName].COD+"（mg/L）<br/>氨氮："+h[b[t].SiteName].NH3N+"（mg/L）<br/>地址："+b[t].SiteAddress),b[t].Basin in v?(v[b[t].Basin].RPI+=h[b[t].SiteName].RPI,v[b[t].Basin].siteNumber+=1):(v[b[t].Basin]={},v[b[t].Basin].RPI=h[b[t].SiteName].RPI,v[b[t].Basin].siteNumber=1)}for(var t in v)v[t].RPI=parseFloat(v[t].RPI)/v[t].siteNumber;y=L.geoJson(w,{style:n,onEachFeature:c}),y.addTo(m)})}function e(o){return o<=2?{disc:"未(稍)受污染",color:"blue"}:o<=3?{disc:"輕度污染",color:"orange"}:o<=6?{disc:"中度污染",color:"red"}:{disc:"嚴重污染",color:"darkpurple"}}function t(){m=new L.Map("RiverMap",{center:new L.LatLng(23.25,120.3),zoom:10.2,zoomControl:!1}),m.touchZoom.disable(),m.doubleClickZoom.disable(),m.scrollWheelZoom.disable(),m.boxZoom.disable(),m.keyboard.disable(),m.dragging.disable();new L.TileLayer("https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicmFwaXJlbnQiLCJhIjoiY2oybXBsc2ZvMDE2YjMycGg4NzNkYXI0OSJ9.xC8TBirQ2os2eQ65hwTCMA",{minZoom:1,maxZoom:16,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(m),S.addTo(m),T.addTo(m)}function n(o){return{fillColor:i(o.properties.name),weight:2,opacity:1,color:"#eee",dashArray:"3",fillOpacity:.4}}function i(o){var e=0;return o+"流域"in v?(e=v[o+"流域"].RPI,e<=2?"#39AADD":e<=3?"#E39941":e<=6?"#D24C39":"#684064"):"transparent"}function r(o){var e=o.target;e.setStyle({weight:5,color:"#666",dashArray:"",fillOpacity:.7}),L.Browser.ie||L.Browser.opera||e.bringToFront(),S.update(e.feature.properties)}function a(o){y.resetStyle(o.target)}function s(o){m.fitBounds(o.target.getBounds()),S.update(o.target.feature.properties)}function c(o,e){e.on({mouseover:r,mouseout:a,click:s})}function l(){if(navigator.geolocation)return navigator.geolocation.getCurrentPosition(d)}function d(o){map.setView(new L.LatLng(o.coords.latitude,o.coords.longitude),12)}function u(){map.setView(new L.LatLng(23.7,121),8)}function p(){N?$(".links").hide():$(".links").show(),N=!N}function f(){$(".rpi-info").show()}function g(){$(".rpi-info").hide()}var m,b,h,y,v={},w=null,N=!1,S=L.control();window.getLocation=l,window.resetView=u,window.toogleLinks=p,window.showRPIInfo=f,window.hideRPIInfo=g;$.getJSON("./src/data/river.geojson",function(o){w=o,y=L.geoJson(w,{style:n,onEachFeature:c}),y.addTo(m),S.update()}),$(document).ready(function(){t(),$.getJSON("./src/data/river.json",function(e){h=e,o()})}),S.onAdd=function(o){return this._div=L.DomUtil.create("div","info"),this._div.innerHTML='<h4>流域圖層載入中 <i class="fa fa-spinner"></i></h4>',this._div},S.update=function(o){o&&o.name+"流域"in v?this._div.innerHTML="<h4>河川流域名稱："+(o?o.name+'</h4>平均污染指數RPI<sup class="rpi-q"><a href="#" onclick="showRPIInfo()">[?]</a></sup>：'+v[o.name+"流域"].RPI.toFixed(1):"</h4>請點選畫面區塊"):this._div.innerHTML="<h4>河川流域名稱："+(o?o.name+"</h4>流域內無測站資料":"</h4>請點選畫面區塊")};var T=L.control({position:"bottomright"});T.onAdd=function(o){for(var e=L.DomUtil.create("div","info legend"),t=["#684064","#D24C39","#E39941","#39AADD"],n=["嚴重污染（6+）","中度污染（3-6）","輕度污染（2-3）","未（稍）受污染（0-2）"],i=0;i<n.length;i++)e.innerHTML+='<i style="background:'+t[i]+'"></i>'+n[i]+"<br/>";return e}}reservoir(),site(),river();
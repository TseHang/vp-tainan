"use strict";function site(){function t(t,i){i.on({mouseover:o,mouseout:e})}function o(t){var o=t.target;for(var e in u)for(var i in u[e].options.town)if(o.feature.properties.TOWNNAME===u[e].options.town[i]){var n=u[e];n.setOpacity(1);for(var r in n.options.town)for(var a in s._layers)s._layers[a].feature.properties.TOWNNAME===n.options.town[r]&&s._layers[a].setStyle({weight:2,color:"#758de5",fillColor:"#758de5",fillOpacity:.7})}o.setStyle({weight:2,color:"#666",fillOpacity:.7}),L.Browser.ie||L.Browser.opera||L.Browser.edge||o.bringToFront(),d.update(o.feature.properties)}function e(t){s.resetStyle(t.target);for(var o in s._layers)s.resetStyle(s._layers[o]);for(var e in u)u[e].setOpacity(.5)}function i(){c=new L.Map("siteMap",{center:new L.LatLng(23.13,120.3),zoom:10.2}),c.touchZoom.disable(),c.doubleClickZoom.disable(),c.scrollWheelZoom.disable(),c.boxZoom.disable(),c.keyboard.disable();new L.TileLayer("https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicmFwaXJlbnQiLCJhIjoiY2oybXBsc2ZvMDE2YjMycGg4NzNkYXI0OSJ9.xC8TBirQ2os2eQ65hwTCMA",{minZoom:1,maxZoom:20,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(c),d.addTo(c),l.addTo(c),p.addTo(c),$.ajax({type:"GET",url:"./src/data/淨水廠.csv",dataType:"text",success:function(t){var o=$.csv.toObjects(t);for(var e in o){var i=L.ExtraMarkers.icon({icon:"fa-tint",iconColor:"white",markerColor:n(o[e]),shape:"circle",prefix:"fa"}),r=L.marker(L.latLng(o[e].lat,o[e].lng),{icon:i,town:o[e]["轄區"].split("、"),name:o[e]["淨水場名稱"],opacity:.5}).addTo(c);r.bindPopup("<strong>"+o[e]["淨水場名稱"]+"</strong><br>主要供水轄區:<strong>"+o[e][" 主要供水轄區"]+"</strong><br>總溶解固體量(Total Dissolved Solids):<strong>"+o[e]["總溶解固體量(Total Dissolved Solids)"]+"</strong><br>pH值(pH ):<strong>"+o[e]["pH值(pH )"]+"</strong><br>總硬度(Total Hardness):<strong>"+o[e]["總硬度(Total Hardness)"]+"</strong><br>鐵(Iron):<strong>"+o[e]["鐵(Iron)"]+"</strong><br>水質合格否(Y/N):<strong>"+o[e]["水質合格否(Y/N)"]+"</strong>"),r.on("popupopen",function(){this.setOpacity(1)}),r.on("popupclose",function(){c.setView(new L.LatLng(23.13,120.3),10.2)}),r.on("mouseover",function(){this.setOpacity(1);var t=this.options.town;for(var o in t)for(var e in s._layers)if(s._layers[e].feature.properties.TOWNNAME===t[o]){var i=s._layers[e];i.setStyle({weight:2,color:"#758de5",fillColor:"#758de5",fillOpacity:.7})}}),r.on("mouseout",function(){this.setOpacity(.5);var t=this.options.town;for(var o in t)for(var e in s._layers)s._layers[e].feature.properties.TOWNNAME===t[o]&&s.resetStyle(s._layers[e])}),u.push(r)}}})}function n(t){return"Y"===t["水質合格否(Y/N)"].toString()?"blue":"N"===t["水質合格否(Y/N)"].toString()?"red":"black"}function r(t){return{fillColor:"#333",weight:2,opacity:1,color:"#eee",dashArray:"3",fillOpacity:.4}}var a=void 0,s=void 0,c=void 0,d=L.control().setPosition("bottomleft"),l=L.control(),p=L.control(),u=[];$.getJSON("./src/data/tainan-town.geojson",function(o){a=o,s=L.geoJson(a,{style:r,onEachFeature:t}),s.addTo(c),d.update()}),$(document).ready(function(){i()}),d.onAdd=function(t){return this._div=L.DomUtil.create("div","siteInfo"),this._div.innerHTML="<h4>圖層載入中</h4>",this._div},d.update=function(t){if(t)for(var o in u)for(var e in u[o].options.town)u[o].options.town[e]===t.TOWNNAME&&(this._div.innerHTML="<h4><strong>"+t.TOWNNAME+"</strong></h4><h4>所屬淨水廠名稱:</h4>"+u[o].options.name);else this._div.innerHTML="<h4>請點選畫面區塊</h4>"},l.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","map outline icon",t);return $(o).on("click",function(){c.setView([23.13,120.3],10.2)}),$(o).attr("title","回到台南"),t},p.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","compass icon",t);return $(o).on("click",function(){if(navigator.geolocation)return navigator.geolocation.getCurrentPosition(function(t){c.setView(new L.LatLng(t.coords.latitude,t.coords.longitude),12)})}),$(o).attr("title","取得您的位置"),t}}function river(){function t(){$.getJSON("./src/data/siteInfo.json",function(t){l=t;for(var e in l)if(l[e].SiteName in p){if(p[l[e].SiteName].RPI=parseFloat(p[l[e].SiteName].RPI),isNaN(p[l[e].SiteName].RPI))continue;var n=o(p[l[e].SiteName].RPI),r=L.ExtraMarkers.icon({prefix:"fa",icon:"fa-map-marker",iconColor:"white",markerColor:n.color,shipe:"circle"}),a=L.marker([l[e].TWD97Lat,l[e].TWD97Lon],{icon:r,opacity:.9}).addTo(d);a.bindPopup("<strong>測站名稱："+l[e].SiteName+'</strong><br/><span class="red">污染程度：'+n.disc+"</span><br/>所屬流域："+l[e].Basin+"<br/>RPI指標："+p[l[e].SiteName].RPI+"<br/>酸鹼值："+p[l[e].SiteName].PH+"<br/>懸浮固體："+p[l[e].SiteName].SS+"（mg/L）<br/>溶氧量："+p[l[e].SiteName].DO+"（mg/L）<br/>生化需氧量："+p[l[e].SiteName].COD+"（mg/L）<br/>氨氮："+p[l[e].SiteName].NH3N+"（mg/L）<br/>地址："+l[e].SiteAddress),l[e].Basin in g?(g[l[e].Basin].RPI+=p[l[e].SiteName].RPI,g[l[e].Basin].siteNumber+=1):(g[l[e].Basin]={},g[l[e].Basin].RPI=p[l[e].SiteName].RPI,g[l[e].Basin].siteNumber=1)}for(var e in g)g[e].RPI=parseFloat(g[e].RPI)/g[e].siteNumber;u=L.geoJson(m,{style:i,onEachFeature:c}),u.addTo(d)})}function o(t){return t<=2?{disc:"未(稍)受污染",color:"blue"}:t<=3?{disc:"輕度污染",color:"orange"}:t<=6?{disc:"中度污染",color:"red"}:{disc:"嚴重污染",color:"darkpurple"}}function e(){d=new L.Map("RiverMap",{center:new L.LatLng(23.13,120.3),zoom:10.2}),d.doubleClickZoom.disable(),d.scrollWheelZoom.disable();new L.TileLayer("https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicmFwaXJlbnQiLCJhIjoiY2oybXBsc2ZvMDE2YjMycGg4NzNkYXI0OSJ9.xC8TBirQ2os2eQ65hwTCMA",{minZoom:1,maxZoom:16,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(d),f.addTo(d),y.addTo(d),h.addTo(d),v.addTo(d)}function i(t){return{fillColor:n(t.properties.name),weight:2,opacity:1,color:"#eee",dashArray:"3",fillOpacity:.4}}function n(t){var o=0;return t+"流域"in g?(o=g[t+"流域"].RPI,o<=2?"#39AADD":o<=3?"#E39941":o<=6?"#D24C39":"#684064"):"transparent"}function r(t){var o=t.target;o.setStyle({weight:5,color:"#666",dashArray:"",fillOpacity:.5}),L.Browser.ie||L.Browser.opera||o.bringToFront(),f.update(o.feature.properties)}function a(t){u.resetStyle(t.target)}function s(t){d.fitBounds(t.target.getBounds()),f.update(t.target.feature.properties)}function c(t,o){o.on({mouseover:r,mouseout:a,click:s})}var d=void 0,l=void 0,p=void 0,u=void 0,g={},m=null,f=L.control(),h=L.control().setPosition("topleft"),v=L.control().setPosition("topleft"),y=L.control({position:"bottomleft"});$.getJSON("./src/data/tainanCounty2010merge.json",function(t){t=L.geoJson(t,{style:{fillColor:"#333",weight:2,opacity:1,color:"#eee",dashArray:"3",fillOpacity:.4}}),t.addTo(d)}),$.getJSON("./src/data/river.geojson",function(t){m=t,u=L.geoJson(m,{style:i,onEachFeature:c}),u.addTo(d),f.update()}),$(document).ready(function(){e(),$.getJSON("./src/data/river.json",function(o){p=o,t()})}),f.onAdd=function(t){return this._div=L.DomUtil.create("div","riverInfo"),this._div.innerHTML="<h4>流域圖層載入中 </h4>",this._div},f.update=function(t){t&&t.name+"流域"in g?this._div.innerHTML="<h4>河川流域名稱："+(t?t.name+"</h4>平均污染指數RPI："+g[t.name+"流域"].RPI.toFixed(1):"</h4>請點選畫面區塊"):this._div.innerHTML="<h4>河川流域名稱："+(t?t.name+"</h4>流域內無測站資料":"</h4>請點選畫面區塊")},y.onAdd=function(t){for(var o=L.DomUtil.create("div","riverInfo legend"),e=["#684064","#D24C39","#E39941","#39AADD"],i=["嚴重污染（6+）","中度污染（3-6）","輕度污染（2-3）","未（稍）受污染（0-2）"],n=0;n<i.length;n++)o.innerHTML+='<i style="background:'+e[n]+'"></i>'+i[n]+"<br/>";return o},h.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","map outline icon",t);return $(o).on("click",function(){d.setView([23.13,120.3],10.2)}),$(o).attr("title","縮放至整個台南市"),t},v.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","compass icon",t);return $(o).on("click",function(){if(navigator.geolocation)return navigator.geolocation.getCurrentPosition(function(t){d.setView(new L.LatLng(t.coords.latitude,t.coords.longitude),12)})}),$(o).attr("title","取得您的位置"),t}}function rain(){function t(){d3.csv("./src/data/酸雨監測值.csv",function(t,o){t&&console.log(t);var e=function(t){var o=[];for(var e in t)o.push(t[e]["監測日期"]);return o}(o),i=d3.max(o,function(t){return parseFloat(t["酸雨pH值"])}),n=d3.min(o,function(t){return parseFloat(t["酸雨pH值"])}),r=d3.scale.linear().domain([0,o.length]).range([padding+axisPadding,width-margin.left-margin.right-padding]),a=d3.scale.linear().domain([n,i]).range([height-margin.top-margin.bottom-padding,padding]),s=d3.select(".initChart"),c=void 0,d=d3.svg.axis().scale(a).tickSize(1).orient("left");$(window).width()<900?(c=d3.svg.axis().scale(r).tickFormat("").tickSize(0).orient("bottom"),$(".rainInfo").css("display","block")):($(".rainInfo").css("display","none"),c=d3.svg.axis().scale(r).tickFormat(function(t,o){return e[o]}).tickSize(1).ticks(o.length).orient("bottom"),s.append("text").attr({class:"yLabel","text-anchor":"end",x:axisPadding,y:height-margin.top-margin.bottom-padding,dy:"2em",opacity:.5}).text("(pH值)")),s.append("g").attr({class:"yAxis",transform:"translate("+axisPadding+",0)"}).call(d).append("text").attr({"text-anchor":"start"}),s.append("g").attr({class:"xAxis",transform:"translate(0,"+(height-margin.top-margin.bottom)+")"}).call(c).selectAll("text").style("text-anchor","start").attr({transform:"rotate(45)"}),$(window).width();var l=d3.svg.line().x(function(t,o){return r(o)}).y(1).interpolate("linear"),p=d3.svg.line().x(function(t,o){return r(o)}).y(function(t){return a(t["酸雨pH值"])}).interpolate("linear");s.append("path").attr({id:"line",d:l(o),y:0,stroke:"#666","stroke-width":"0.5px",fill:"none"}).transition().duration(1e3).attr("d",p(o));var u=d3.select("body").append("div").attr("class","info").style("opacity",0),g=0,m=s.selectAll(".point").data(o).enter().append("circle").attr({cx:function(t,o){return r(o)},cy:function(t){return a(t["酸雨pH值"])},r:function(t){if(!0===trigger)return 9;var o=Math.sqrt(10*t["雨量累計 (mm)"]);return o<9?9:o},fill:function(t){return t["酸雨pH值"]>=5.6?"#758de5":t["酸雨pH值"]>=5?"#ff7800":"#ea5a5a"},opacity:.5,class:"rainPoint",id:function(t){return t["序號"]},date:function(t){return t["監測日期"]},elect:function(t){return t["雨水導電度 (μS/cm)"]},total:function(t){return t["雨量累計 (mm)"]},site:function(t){return t["測站"]}});$(window).width()>=900?m.on("mouseover",function(){d3.select(this).attr({opacity:.9,stroke:"rgba(0, 0, 0, 0.12)","stroke-width":2,cursor:"pointer"})}).on("mouseout",function(){d3.select(this).attr({opacity:.5,stroke:"rgba(0, 0, 0, 0.12)","stroke-width":0})}).on("click",function(){d3.select(this).attr("id")!==g?(u.html('<div id="info"> 監測日期: <strong>'+d3.select(this).attr("date")+"</strong><br>雨水導電度 (μS/cm): <strong>"+d3.select(this).attr("elect")+"</strong><br>雨量累計 (mm): <strong>"+d3.select(this).attr("total")+"</strong><br>測站: <strong>"+d3.select(this).attr("site")+"</div>").style({left:d3.event.pageX+"px",top:d3.event.pageY+"px",opacity:1,"z-index":999}),g=d3.select(this).attr("id")):(g=0,u.style({opacity:0,"z-index":-1}))}):m.on("click",function(){$(".rainInfo").css("display","block"),d3.select(this).attr("id")!==g?(g=d3.select(this).attr("id"),$(".rainInfo").empty().html('<div id="info"> 監測日期: <strong>'+d3.select(this).attr("date")+"</strong><br>雨水導電度 (μS/cm): <strong>"+d3.select(this).attr("elect")+"</strong><br>雨量累計 (mm): <strong>"+d3.select(this).attr("total")+"</strong><br>測站: <strong>"+d3.select(this).attr("site")+"</div>"),d3.selectAll(".rainPoint").style({opacity:.5,stroke:"rgba(0, 0, 0, 0.12)","stroke-width":0}),d3.select(this).style({opacity:.9,stroke:"rgba(0, 0, 0, 0.12)","stroke-width":2,cursor:"pointer"})):(g=0,d3.select(this).style({opacity:.5,stroke:"rgba(0, 0, 0, 0.12)","stroke-width":0}),$(".rainInfo").css("display","none"))})})}$(document).ready(function(){d3.selectAll("initChart").remove(),d3.select("#column").append("initChart").append("svg").attr("width",width).attr("height",height).attr("class","initChart"),t()})}function groundwater(){function t(t){var e={},i=!1;for(var n in o)t[n]>o[n]&&(i=!0,e[n+"  :"]=t[n]);return!0===i?{disc:e,color:"red"}:{disc:e,color:"blue"}}var o={"砷 Arsenic (mg/L)":.25,"鎘 Cadmium (mg/L)":.025,"鉻 Chromium (mg/L)":.25,"銅 Copper (mg/L)":.25,"鉛 Lead (mg/L)":.05,"汞 Mercury (mg/L)":.01,"鋅 Zinc (mg/L)":25,"鐵 Iron (mg/L)":1.5,"錳 Manganese (mg/L)":.25,"總硬度 Total Hardness (mg/L as CaCO3)":750,"總溶解固體物 Total Dissolved Solid (mg/L)":1250,"氯鹽 Chloride (mg/L)":625,"氨氮 NH3-N (mg/L)":.25,"硝酸鹽氮 Nitrate-Nitrogen (mg/L)":50,"硫酸鹽 Sulfate (mg/L)":625,"總有機碳 Total Organic Carbon (mg/L)":10},e=L.control().setPosition("topleft"),i=L.control().setPosition("topleft"),n=void 0,r=void 0,a=null;$(document).ready(function(){$.getJSON("./src/data/tainan-town.geojson",function(t){a=t,r=L.geoJson(a,{style:{fillColor:"#333",weight:2,opacity:1,color:"#eee",dashArray:"3",fillOpacity:.2}}),r.addTo(n),e.addTo(n),i.addTo(n)})}),function(){n=new L.Map("groundWater",{center:new L.LatLng(23.13,120.3),zoom:10.2}),n.doubleClickZoom.disable(),n.scrollWheelZoom.disable(),new L.TileLayer("https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicmFwaXJlbnQiLCJhIjoiY2oybXBsc2ZvMDE2YjMycGg4NzNkYXI0OSJ9.xC8TBirQ2os2eQ65hwTCMA",{minZoom:1,maxZoom:16,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(n),d3.csv("./src/data/地下水水質監測與指標資料.csv",function(o,e){o&&console.log(o);for(var i in e){var r=t(e[i]),a=L.ExtraMarkers.icon({icon:"fa-tint",iconColor:"white",markerColor:r.color,shape:"circle",prefix:"fa"}),s=L.marker(L.latLng(e[i].TWD97Lat,e[i].TWD97Lon),{icon:a,opacity:.7}).addTo(n),c="";for(var d in r.disc)c+="</span><br>"+d+'<span class="red">',c+=r.disc[d];s.on("popupopen",function(){this.setOpacity(1)}),s.on("popupclose",function(){this.setOpacity(.7)}),s.bindPopup("測站:<strong>"+e[i]["測站"]+"</strong><br>地址:<strong>"+e[i].SiteAddress+"</strong><br>最後採樣日期:<strong>"+e[i]["採樣日期"]+"</strong>"+(""===c?"<hr>無超標項目":"<hr>超標項目<span>")+c)}})}(),e.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","map outline icon",t);return $(o).on("click",function(){n.setView([23.13,120.3],10.2)}),$(o).attr("title","回到台南"),t},i.onAdd=function(){var t=L.DomUtil.create("button","ui compact icon button"),o=L.DomUtil.create("i","compass icon",t);return $(o).on("click",function(){if(navigator.geolocation)return navigator.geolocation.getCurrentPosition(function(t){n.setView(new L.LatLng(t.coords.latitude,t.coords.longitude),12)})}),$(o).attr("title","取得您的位置"),t}}var margin={top:10,right:0,bottom:140,left:0},height=450,padding=30,barMargin=5,axisPadding=80,trigger=!1,width=800+axisPadding;$(window).ready(function(){site(),river(),rain(),groundwater(),$(window).width()<900&&(d3.selectAll("initChart").remove(),$("#siteMap, #groundWater").css({width:"100%",transform:"translateX(0)"}),axisPadding=40,width=$(window).width()-90+axisPadding,margin.bottom=20,trigger=!0,rain()),$(window).resize(function(){$(window).width()<900&&!1===trigger?(d3.selectAll("initChart").remove(),$("#siteMap, #groundWater").css({width:"100%",transform:"translateX(0)"}),axisPadding=40,width=$(window).width()-90+axisPadding,margin.bottom=20,trigger=!0,rain()):!0===trigger&&(d3.selectAll("initChart").remove(),$("#siteMap, #groundWater").css({width:"50%",transform:"translateX(50%)"}),trigger=!1,axisPadding=80,width=800+axisPadding,margin.bottom=140,rain())})});
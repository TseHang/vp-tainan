"use strict";function formatData(t){for(var e={name:t[0].name,budget_106:t[0].budget_106,budget_105:t[0].budget_105,final_accounts_104:t[0].final_accounts_104,compare_106_105:t[0].compare_106_105,children:[]},a=0,r=1;r<t.length;r++){var n=parseInt(t[r].subject,10);n===a+1&&(a+=1),n===a&&(t[r].item?e.children[a-1].children.push({name:t[r].name,budget_106:t[r].budget_106,budget_105:t[r].budget_105,final_accounts_104:t[r].final_accounts_104,compare_106_105:t[r].compare_106_105,item:parseInt(t[r].item,10),children:[]}):e.children.push({name:t[r].name,budget_106:t[r].budget_106,budget_105:t[r].budget_105,final_accounts_104:t[r].final_accounts_104,compare_106_105:t[r].compare_106_105,item:n,children:[]}))}return e}function update(t,e){function a(t){$(".detail-container").addClass("show");var e=parseFloat(t.budget_106.replace(/,/gi,"")),a=parseFloat(t.budget_105.replace(/,/gi,"")),r=parseFloat(t.final_accounts_104.replace(/,/gi,"")),n=parseFloat(t.compare_106_105.replace(/,/gi,""))/a,i=parseFloat(o.budget_106.replace(/,/gi,"")),l=1===t.id?i:parseFloat(t.parent.budget_106.replace(/,/gi,"")),c=t._children?t._children.length:0;e=isNaN(e)?0:e,$("#percentParent").text(u(e,l,$("#percentParent"))),$("#percentAll").text(u(e,i,$("#percentAll"))),$("#children").text(c),e=s(e),a=s(a),r=s(r),n=isNaN(n)?0:n,$("#item").text(t.name),$("#budget_106").text(e),$("#budget_105").text(a),$("#compare_106_105").text(function(){return n>=0?($(this).addClass("positive"),"+ "+formatFloat(n,2)+"%"):($(this).removeClass("positive"),formatFloat(n,2)+"%")}),$("#final_accounts_104").text(r)}var r=(!(arguments.length>2&&void 0!==arguments[2])||arguments[2],tree.nodes(root)),n=Math.max(150,r.length*barHeight+margin.top+margin.bottom),o=r[0];console.log(r,1111),d3.select("#"+e).transition().duration(duration).attr("height",n),r.forEach(function(t,e){t.x=e*barHeight});var i=d3.select("#"+e+" > g"),l=i.selectAll("g.node").data(r,function(t,e){return t.id||(t.id=++e)}),c=l.enter().append("g").attr("class","node").attr("transform","translate("+t.y0+","+t.x0+")");c.append("rect").attr("y",-barHeight/2).attr("height",barHeight).attr("width",barWidth).attr("class",function(t){return t._children?"rect collapse-close":"rect"}).style("fill",color).on("click",function(t){console.log(t),t.children?(console.log(1),t._children=t.children,t.children=null,d3.select(this).attr("class","rect collapse-close"),console.log(11111)):(console.log(2),t.children=t._children,t._children=null,d3.select(this).attr("class","rect")),update(t,e)}).on("mouseenter",a).on("mouseleave",function(){$(".detail-container").removeClass("show")}),c.append("text").attr("dy",3.5).attr("dx",5.5).text(function(t){if(1===t.depth){var e=parseFloat(t.budget_106.replace(/,/gi,"")),a=parseFloat(o.budget_106.replace(/,/gi,""));return t.name+"("+formatFloat(e/a*100,1)+"%): "+t.budget_106}return t.name+": "+t.budget_106}),c.append("text").attr("dy",3.5).attr("dx",5.5).attr("class","collapse-mark").attr("transform","translate("+.75*$("#"+e).width()+", 0)").style("display",function(t){return t.depth>=2?"none":"block"}).text("-"),c.transition().duration(duration).attr("transform",function(t){return"translate("+t.y+","+t.x+")"}),l.select(".collapse-mark").text(function(t){return t.children?"-":"+ "}),l.transition().duration(duration).attr("transform",function(t){return"translate("+t.y+","+t.x+")"}).select("rect").style("fill",color),l.exit().transition().duration(duration).attr("transform","translate("+t.y0+","+t.x0+")").remove();var d=i.selectAll("path.link").data(tree.links(r),function(t){return t.target.id});d.enter().insert("path","g").attr("class","link").attr("d",function(){var e={x:t.x0,y:t.y0};return diagonal({source:e,target:e})}).transition().duration(duration).attr("d",diagonal),d.transition().duration(duration).attr("d",diagonal),d.exit().transition().duration(duration).attr("d",function(){var e={x:t.x,y:t.y};return diagonal({source:e,target:e})}).remove(),r.forEach(function(t){t.x0=t.x,t.y0=t.y});var s=function(t){if(isNaN(t))return 0;var e=t/1e5;return e<.005?t/10+" 萬元":formatFloat(e,2)+" 億元"},u=function(t,e,a){var r=t/e*100;return r>=10?a.addClass("color-red p-size-big"):a.removeClass("color-red p-size-big"),formatFloat(r,1)}}var d3=window.d3,$=window.$,formatFloat=formatFloat,isMobile=isMobile,margin={top:30,right:20,bottom:30,left:20},barHeight=isMobile?40:30,barWidth="80%",duration=400,color=function(t){return t._children?"#F34708":t.children?"#FFAA0A":"#D7DAE1"},root=void 0,tree=d3.layout.tree().nodeSize([0,20]),diagonal=d3.svg.diagonal().projection(function(t){return[t.y,t.x]});d3.csv("./src/data/money_revenue_106.csv",function(t){var e=formatData(t);d3.select("#svg-annual-income").append("g").attr("transform","translate("+margin.left+","+margin.top+")"),e.x0=0,e.y0=0,update(root=e,"svg-annual-income")}),d3.csv("./src/data/money_expenditure_106.csv",function(t){var e=formatData(t);d3.select("#svg-annual-expenditure").append("g").attr("transform","translate("+margin.left+","+margin.top+")"),e.x0=0,e.y0=0,update(root=e,"svg-annual-expenditure")});
"use strict";function getLocation(t){t.locate({setView:!0,maxZoom:15}).on("locationfound",function(e){void 0!=markers.userLocation&&mymap.removeLayer(markers.userLocation),markers.userLocation=L.marker([e.latitude,e.longitude]).bindPopup("你在這裡 :)").addTo(t).openPopup()})}function goToByScroll(t){$("html,body").animate({scrollTop:$("#"+t).offset().top-100},"slow")}function addEventCircle(t,e){var a=t.lat,n=t.lng,r=t.daynight,i=t.date,o=t.hour,s=t.rush;if(void 0!==a||void 0!==n)if("day"===r)if(s){var c="circle day rush "+o,l=L.circle([a,n],{color:"#ff6f69",stroke:!1,fillColor:"#ff6f69",fillOpacity:.7,radius:20,className:c}).addTo(e);l.bindPopup("時間： "+i.toString())}else{var d="circle day nonrush "+o,p=L.circle([a,n],{color:"#ff6f69",stroke:!1,fillColor:"#ff6f69",fillOpacity:.7,radius:20,className:d}).addTo(e);p.bindPopup("時間： "+i.toString())}else if(s){var u="circle night rush "+o,m=L.circle([a,n],{color:"#265665",stroke:!1,fillColor:"#265665",fillOpacity:.7,radius:20,className:u}).addTo(e);m.bindPopup("時間： "+i.toString())}else{var h="circle night nonrush "+o,g=L.circle([a,n],{color:"#265665",stroke:!1,fillColor:"#265665",fillOpacity:.7,radius:20,className:h}).addTo(e);g.bindPopup("時間： "+i.toString())}}function addWarningArea(t,e){var a=t.lat,n=t.lng,r=t.name;L.circle([a,n],{color:"#FFCC00",stroke:!1,fillColor:"#FFCC00",fillOpacity:.6,radius:100,className:"warningArea"}).addTo(e).bindPopup(r+", 累積事件數："+t.count)}function brushed(){if(d3.event.sourceEvent&&d3.event.selection){var t=d3.event.selection.map(x.invert),e=t.map(function(t){return+parseInt(t)});e[0]>=e[1]&&(e[0]=t[0],e[1]=t[0]+1),d3.select(this).transition().call(d3.event.target.move,e.map(x)),$("#night_toggle").removeAttr("checked"),$("#day_toggle").removeAttr("checked"),$(".day").css("visibility","hidden"),$(".night").css("visibility","hidden");for(var a=e[0];a<=e[1];a++){var n=".hour"+a;$(n).css("visibility","visible")}}}function pieChart(){var t=d3.select("#pieChart").append("svg").attr("width","100%").attr("height",420),e=d3.svg.arc().innerRadius(125).outerRadius(150),a=t.append("g").attr("id","pieSvg").attr("class","pie-svg").attr("transform","translate("+$("#pieChart").width()/2+",210)");a.append("g").append("circle").attr("cx",0).attr("cy",0).attr("r",112.5).attr("fill","none").attr("stroke","#BEBEBE").attr("stroke-width",3),a.append("g").attr("class","lines");var n=d3.layout.pie().value(function(t){return t.times}).sort(null),r=d3.select("#pieChart").append("div").attr("class","tooltip");r.append("div").attr("class","event"),r.append("div").attr("class","times"),r.append("div").attr("class","percent"),d3.csv("./src/data/trafficExposedData.csv",function(i,o){function s(t){return t.startAngle+(t.endAngle-t.startAngle)/2}var c=[];o.forEach(function(t){c.push(t.event)});var l=d3.scale.ordinal().domain(c).range(["#4F9D9D","#95CACA","#5A5AAD","#A6A6D2","#C07AB8","#FFAD86","#FF95CA","#00E3E3","#009393","#46A3FF","#66CDAA","#8600FF","#CA8EFF","#FFB5B5"]);o.forEach(function(t){t.times=+t.times});var d=a.selectAll("path").data(n(o)).enter().append("path").attr("d",e).attr("fill",function(t,e){return l(t.data.event)});r.select(".event").html('<h1 class="tooltip-title">舉發總件數</h1><div class="title-line"></div>'),r.select(".times").html("370,040 件");var p=d3.sum(o.map(function(t){return t.times}));d.on("mouseover",function(t){var e=Math.round(1e3*t.data.times/p)/10,a=d3.format(","),n=d3.svg.arc().innerRadius(133).outerRadius(158);r.select(".event").html('<h1 class="tooltip-title">'+t.data.event+'</h1><div class="title-line"></div>'),r.select(".times").html(a(t.data.times)+" 件"),r.select(".percent").html(e+"%"),d3.select(this).transition().duration(300).attr("d",n)}),d.on("mouseout",function(){r.select(".event").html('<h1 class="tooltip-title">舉發總件數</h1><div class="title-line"></div>'),r.select(".times").html("370,040 件"),r.select(".percent").html(""),d3.select(this).transition().duration(300).attr("d",e)});var u=a.append("g").attr("transform","translate(0,0)"),m=d3.svg.arc().innerRadius(120).outerRadius(160),h=d3.svg.arc().innerRadius(190).outerRadius(190);u.selectAll("text").data(n(o)).enter().append("text").attr("class","label-style").attr("transform",function(t){var e=h.centroid(t);return e[0]=200*(s(t)<Math.PI?1:-1),"translate("+e+")"}).attr("text-anchor",function(t){return-1==(s(t)<Math.PI?1:-1)?"end":"start"}).text(function(t){var e=d3.sum(o.map(function(t){return t.times})),a=Math.round(1e3*t.data.times/e)/10;return t.data.event+" "+a+"%"});var g=(u.selectAll("polyline").data(n(o),function(t){return t.data.event}).enter().append("polyline").attr("points",function(t){var e=h.centroid(t);return e[0]=190*(s(t)<Math.PI?1:-1),[m.centroid(t),h.centroid(t),e]}),o.sort(function(t,e){return e.times-t.times})),f=t.append("g").attr("id","legendSvg").attr("class","legend-svg").attr("transform","translate("+$("#pieChart").width()/15+",180)").selectAll(".legend-style").data(g).enter().append("g").attr("class","legend-style").attr("transform",function(t,e){return"translate(0,"+(26*e-26*g.length/2+10)+")"});f.append("rect").attr("width",18).attr("height",18).style("fill",function(t){return l(t.event)}).style("stroke",function(t){return l(t.event)}),f.append("text").attr("x",28).attr("y",14).text(function(t){var e=Math.round(1e3*t.times/p)/10;return t.event+" "+e+"%"})})}var mymap=L.map("accidentMap").setView([22.9945,120.21208],14);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy;<a href="https://carto.com/attribution">CARTO</a>'}).addTo(mymap);var legend=L.control({position:"bottomright"}),legendLocation=L.control({position:"bottomright"});legend.onAdd=function(){for(var t=L.DomUtil.create("div","info legend"),e=["#ff6f69","#265665"],a=["白天(5:00-17:00)","晚上(17:00-5:00)"],n=0;n<a.length;n++)t.innerHTML+='<p><i style="background:'+e[n]+'"></i> '+a[n]+"<br></p>";return t},legendLocation.onAdd=function(){var t=L.DomUtil.create("div","info legend");return t.innerHTML+='<button class="ui button" style="background-color:#ffffff" id="getLocationButton">移動到我的位置</button>',t},legend.addTo(mymap),legendLocation.addTo(mymap);var markers={};$("#day_toggleCheckbox").checkbox().on("click",function(){$("#day_toggle").is(":checked")?$(".day").css("visibility","visible"):$(".day").css("visibility","hidden")}),$("#night_toggleCheckbox").checkbox().on("click",function(){$("#night_toggle").is(":checked")?$(".night").css("visibility","visible"):$(".night").css("visibility","hidden")}),$("#warning_area_checkbox_wrap").checkbox().on("click",function(){$("#warning_area_checkbox").is(":checked")?$(".warningArea").css("visibility","visible"):$(".warningArea").css("visibility","hidden")}),$("#getLocationButton").on("click",function(){getLocation(mymap)}),$(".list>li").click(function(){var t=parseInt($(this).attr("id").replace("area",""));goToByScroll("accidentMap");switch(t){case 1:mymap.panTo(new L.LatLng(22.99849,120.24912)),L.marker([22.99849,120.24912]).bindPopup("事故密集區：復興路往國道一號交流道附近").addTo(mymap).openPopup();break;case 2:mymap.panTo(new L.LatLng(22.99542,120.19957)),L.marker([22.99542,120.19957]).bindPopup("事故密集區：西門圓環往民生路一段沿路").addTo(mymap).openPopup();break;case 3:mymap.panTo(new L.LatLng(22.99833,120.23468)),L.marker([22.99833,120.23468]).bindPopup("事故密集區：小東路與中華東路口").addTo(mymap).openPopup();break;case 4:mymap.panTo(new L.LatLng(22.98397,120.2251)),L.marker([22.98397,120.2251]).bindPopup("事故密集區：東門路二段 (與裕豐街交叉路口、與裕農路交叉路口)").addTo(mymap).openPopup();break;case 5:mymap.panTo(new L.LatLng(22.99283,120.20499)),L.marker([22.99283,120.20499]).bindPopup("事故密集區：民生綠園圓環(台灣文學館)").addTo(mymap).openPopup();break;case 6:mymap.panTo(new L.LatLng(22.99456,120.19614)),L.marker([22.99456,120.19614]).bindPopup("事故密集區：海安路一段與正興街路口").addTo(mymap).openPopup()}}),$.getJSON("./src/data/trafficeRawData.json",function(t){$.each(t,function(t,e){addEventCircle(e,mymap)})}),$.getJSON("./src/data/trafficWarningAreas.json",function(t){$.each(t,function(t,e){addWarningArea(e,mymap)})});var svg=d3.select("#linechart svg"),margin={top:20,right:20,bottom:30,left:50},width=$("#linechart").width()-10,height=+svg.attr("height")-margin.bottom,g=svg.append("g").attr("transform","translate(0,5)"),x=d3.scaleLinear().rangeRound([0,width]),y=d3.scaleLinear().rangeRound([height,0]),brush=d3.brushX().extent([[0,0],[width,height]]).on("brush end",brushed),area=d3.area().x(function(t){return x(t.hour)}).y1(function(t){return y(t.count)});d3.csv("./src/data/trafficHourSummary.csv",function(t){return t.hour=t.hour,t.count=+t.count,t},function(t,e){if(t)throw t;x.domain([0,23]),y.domain([0,d3.max(e,function(t){return t.count+30})]),area.y0(y(0)),g.append("path").datum(e).attr("fill","grey").attr("opacity","0.4").attr("d",area),g.append("g").attr("class","axis").attr("transform","translate(2,"+height+")").call(d3.axisBottom(x).ticks(24)),g.append("g").attr("class","brush").call(brush).call(brush.move,x.range())}),$(".hourButton").on("click",function(){var t=$(this).attr("value"),e=d3.select(".brush").transition().duration(400),a=d3.brushSelection(e.node()).map(x.invert),n=a.map(function(t){return Math.round(t)});"plus"===t?(n[1]<=22?n[1]+=1:n[0]>0&&(n[0]-=1),n[0]>=n[1]&&(n[0]=a[0],n[1]=a[0]+1)):"minus"===t&&(n[0]>0?n[0]+=1:n[1]<=23&&(n[1]-=1),n[0]>=n[1]&&(n[0]=a[0],n[1]=a[0]+1)),23===n[1]&&-1===n[0]?brush.move(e,[9,21].map(x)):23===n[1]&&0===n[0]?brush.move(e,[9,21].map(x)):brush.move(e,n.map(x)),$(".day").css("visibility","hidden"),$(".night").css("visibility","hidden");for(var r=n[0];r<=n[1];r++){var i=".hour"+r;$(i).css("visibility","visible")}}),pieChart();
"use strict";function getLocation(t){t.locate({setView:!0,maxZoom:15}).on("locationfound",function(i){var n=L.marker([i.latitude,i.longitude]).bindPopup("你在這裡 :)");t.addLayer(n)})}function addEventCircle(t,i){var n=t.lat,e=t.lng,a=t.daynight,o=t.date,r=t.hour,c=t.rush;if(void 0!==n||void 0!==e)if("day"===a)if(c){var s="circle day rush "+r,l=L.circle([n,e],{color:"#ff6f69",stroke:!1,fillColor:"#ff6f69",fillOpacity:.7,radius:20,className:s}).addTo(i);l.bindPopup("時間： "+o.toString())}else{var d="circle day nonrush "+r,u=L.circle([n,e],{color:"#ff6f69",stroke:!1,fillColor:"#ff6f69",fillOpacity:.7,radius:20,className:d}).addTo(i);u.bindPopup("時間： "+o.toString())}else if(c){var h="circle night rush "+r,g=L.circle([n,e],{color:"#265665",stroke:!1,fillColor:"#265665",fillOpacity:.7,radius:20,className:h}).addTo(i);g.bindPopup("時間： "+o.toString())}else{var f="circle night nonrush "+r,p=L.circle([n,e],{color:"#265665",stroke:!1,fillColor:"#265665",fillOpacity:.7,radius:20,className:f}).addTo(i);p.bindPopup("時間： "+o.toString())}}function addWarningArea(t,i){var n=t.lat,e=t.lng;t.name;L.circle([n,e],{color:"#FFCC00",stroke:!1,fillColor:"#FFCC00",fillOpacity:.6,radius:100,className:"warningArea"}).addTo(i).bindPopup(t.name+", 累積事件數："+t.count+"lat,lng: "+n)}function brushed(){if(d3.event.sourceEvent&&d3.event.selection){var t=d3.event.selection.map(x.invert),i=t.map(function(t){return+parseInt(t)});i[0]>=i[1]&&(i[0]=t[0],i[1]=t[0]+1),d3.select(this).transition().call(d3.event.target.move,i.map(x)),$("#night_toggle").removeAttr("checked"),$("#day_toggle").removeAttr("checked"),$(".day").css("visibility","hidden"),$(".night").css("visibility","hidden");for(var n=i[0];n<=i[1];n++){var e=".hour"+n;$(e).css("visibility","visible")}}}var mymap=L.map("accidentMap").setView([22.9945,120.21208],14);L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy;<a href="https://carto.com/attribution">CARTO</a>'}).addTo(mymap);var legend=L.control({position:"bottomright"}),legendLocation=L.control({position:"bottomright"});legend.onAdd=function(){for(var t=L.DomUtil.create("div","info legend"),i=["#ff6f69","#265665"],n=["白天(5:00-17:00)","晚上(17:00-5:00)"],e=0;e<n.length;e++)t.innerHTML+='<p><i style="background:'+i[e]+'"></i> '+n[e]+"<br></p>";return t},legendLocation.onAdd=function(){var t=L.DomUtil.create("div","info legend");return t.innerHTML+='<button class="ui button" style="background-color:#ffffff" id="getLocationButton">移動到我的位置</button>',t},legend.addTo(mymap),legendLocation.addTo(mymap),$("#day_toggleCheckbox").checkbox().on("click",function(){$("#day_toggle").is(":checked")?$(".day").css("visibility","visible"):$(".day").css("visibility","hidden")}),$("#night_toggleCheckbox").checkbox().on("click",function(){$("#night_toggle").is(":checked")?$(".night").css("visibility","visible"):$(".night").css("visibility","hidden")}),$("#warning_area_checkbox_wrap").checkbox().on("click",function(){$("#warning_area_checkbox").is(":checked")?$(".warningArea").css("visibility","visible"):$(".warningArea").css("visibility","hidden")}),$("#getLocationButton").on("click",function(){getLocation(mymap)}),$.getJSON("./src/data/trafficeRawData.json",function(t){$.each(t,function(t,i){addEventCircle(i,mymap)})}),$.getJSON("./src/data/trafficWarningArea.json",function(t){$.each(t,function(t,i){addWarningArea(i,mymap)})});var svg=d3.select("#linechart svg"),margin={top:20,right:20,bottom:30,left:50},width=$("#linechart").width()-10,height=+svg.attr("height")-margin.bottom,g=svg.append("g").attr("transform","translate(0,5)"),x=d3.scaleLinear().rangeRound([0,width]),y=d3.scaleLinear().rangeRound([height,0]),brush=d3.brushX().extent([[0,0],[width,height]]).on("brush end",brushed),area=d3.area().x(function(t){return x(t.hour)}).y1(function(t){return y(t.count)});d3.csv("./src/data/trafficHourSummary.csv",function(t){return t.hour=t.hour,t.count=+t.count,t},function(t,i){if(t)throw t;x.domain([0,23]),y.domain([0,d3.max(i,function(t){return t.count+30})]),area.y0(y(0)),g.append("path").datum(i).attr("fill","grey").attr("opacity","0.4").attr("d",area),g.append("g").attr("class","axis").attr("transform","translate(2,"+height+")").call(d3.axisBottom(x).ticks(24)),g.append("g").attr("class","brush").call(brush).call(brush.move,x.range())}),$(".hourButton").on("click",function(){var t=$(this).attr("value"),i=d3.select(".brush").transition().duration(400),n=d3.brushSelection(i.node()).map(x.invert),e=n.map(function(t){return Math.round(t)});"plus"==t?(e[1]<=22?e[1]+=1:e[0]>0&&(e[0]-=1),e[0]>=e[1]&&(e[0]=n[0],e[1]=n[0]+1)):"minus"==t&&(e[0]>0?e[0]+=1:e[1]<=23&&(e[1]-=1),e[0]>=e[1]&&(e[0]=n[0],e[1]=n[0]+1)),23==e[1]&&-1==e[0]||0==e[0]?brush.move(i,[9,21].map(x)):brush.move(i,e.map(x)),$(".day").css("visibility","hidden"),$(".night").css("visibility","hidden");for(var a=e[0];a<=e[1];a++){var o=".hour"+a;$(o).css("visibility","visible")}});